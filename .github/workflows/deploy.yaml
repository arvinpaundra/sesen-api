name: Deploy Sesen API to Kubernetes cluster

on:
  push:
    tags:
      - 'v*.*.*'

env:
  APP_NAME: sesen-api
  KUBE_NAMESPACE: sesen
  IMAGE_NAME: arvinpaundra/sesen-api

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Checkout code
      - name: Checkout
        uses: actions/checkout@v4

      # Set up Docker
      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      # Login to Docker registry
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Build & push image
      - name: Build and push image
        run: |
          IMAGE_TAG=${GITHUB_SHA::7}
          docker build -t $IMAGE_NAME:$IMAGE_TAG .
          docker push $IMAGE_NAME:$IMAGE_TAG
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      # Set up kubectl
      - name: Setup kubectl
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_B64 }}" | base64 -d > ~/.kube/config
          kubectl version --client

      # Apply base manifests
      - name: Apply base Kubernetes manifests
        run: |
          kubectl apply -f deploy/k8s/namespace.yaml
          kubectl apply -f deploy/k8s/configmap.yaml
          kubectl apply -f deploy/k8s/service.yaml
          kubectl apply -f deploy/k8s/ingress.yaml

      # Inject secrets securely
      - name: Apply Kubernetes Secret
        env:
          DB_USER: '${{ secrets.DB_USER }}'
          DB_PASS: '${{ secrets.DB_PASS }}'
          DB_HOST: '${{ secrets.DB_HOST }}'
          DB_PORT: '${{ secrets.DB_PORT }}'
          DB_DBNAME: '${{ secrets.DB_DBNAME }}'
          DB_SSLMODE: '${{ secrets.DB_SSLMODE }}'
          DB_TIMEZONE: '${{ secrets.DB_TIMEZONE }}'
          JWT_SECRET_KEY: '${{ secrets.JWT_SECRET_KEY }}'
        run: |
          envsubst < deploy/k8s/secret.yaml | kubectl apply -f -

      # Deploy application
      - name: Deploy application
        run: |
          sed "s|IMAGE_PLACEHOLDER|$IMAGE_NAME:$IMAGE_TAG|g" deploy/k8s/deployment.yaml | kubectl apply -f -

      # Force rollout to pick up new image & secrets
      - name: Restart deployment
        run: |
          if kubectl get deployment $APP_NAME -n $KUBE_NAMESPACE &> /dev/null; then
            kubectl rollout restart deployment/$APP_NAME -n $KUBE_NAMESPACE
            kubectl rollout status deployment/$APP_NAME -n $KUBE_NAMESPACE
          else
            echo "Deployment $APP_NAME not found in namespace $KUBE_NAMESPACE, skipping restart"
          fi
